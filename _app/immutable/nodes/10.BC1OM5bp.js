import"../chunks/DsnmJJEf.js";import{o as x,h as M,d as F,s as G}from"../chunks/BOOa181H.js";import{p as H,g as W,k as t,f as m,a as v,b as u,c as z,Z as f,t as T,s as _,Y as E,$ as j,a0 as B,d as I,r as w}from"../chunks/YEsR6uFO.js";import{i as g}from"../chunks/C7VAiwEf.js";import{s as D}from"../chunks/D1LHmu9n.js";import{b as J}from"../chunks/x5owbScQ.js";import{S as V,w as Z,e as Q,i as N}from"../chunks/87qpYtHj.js";import{p as X}from"../chunks/CSVxk9od.js";var ee=m('<iframe frameborder="0" allowfullscreen="" title="Integration Test Frame" class="svelte-1hcx36q"></iframe>'),re=m('<div class="container svelte-1hcx36q"><h2>Error</h2> <p> </p></div>'),te=m('<div class="container svelte-1hcx36q"><h2>Awaiting src...</h2> <p>Add ?src=YOUR_URL to the page URL, or refresh to re-prompt.</p></div>'),oe=m("<!> <!> <!>",1);function ue(A,L){H(L,!0);let b=f(!1),p=f(null),y=f(!1),U=f(!0),l=f(null),q=!1,c=f(null);const K="ccported_tokens";function h(){try{const e=localStorage.getItem(K);if(!e)return null;const r=JSON.parse(e);return{accessToken:r?.accessToken,idToken:r?.idToken,refreshToken:r?.refreshToken}}catch{return null}}function k(){try{return t(c)?new URL(t(c)).origin:null}catch{return null}}x(async()=>{await N();const e=X.url.searchParams.get("src");if(e&&e.trim().length>0)E(c,e.trim(),!0);else{const r="http://localhost:8080/index.html",s=window.prompt("Enter iframe src URL to test (leave blank to use default)",r);E(c,s&&s.trim().length>0?s.trim():r,!0)}}),W(()=>{t(c)&&!t(p)&&(setTimeout(()=>{t(l)&&t(l).addEventListener("load",async e=>{if(!t(l))return;const r=t(l).contentWindow;if(!r)return;V.awsReady||await Z();const s=h();if(s&&(s.idToken||s.accessToken)){console.log("[R][PLAY][updateIframe] Iframe loaded. User logged in: true");try{const n=s,o=k()||"*";r.postMessage({action:"SET_TOKENS",content:n},o)}catch(n){console.error("Error sending tokens:",n)}}else console.log("[R][PLAY][updateIframe] Iframe loaded. User not logged in.");t(l).focus()})},0),window.addEventListener("message",async e=>{try{if(!e.data.fromInternal)return;const r=[...Q.servers.map(o=>`https://${o.hostname}`)],s=k();if(s&&r.push(s),!["http://localhost:5173",...r].includes(e.origin)){console.warn(`[R][PLAY][updateIframe][message] Rejected message from unauthorized origin: ${e.origin}`);return}const n=e.data;if(n.action==="GET_TOKENS"){const o={requestId:n.requestId},i=h();if(i&&(i.idToken||i.accessToken)){console.log("[R][PLAY][updateIframe][message-GET_TOKENS] User logged in, sending tokens");try{const a=i;o.action="SET_TOKENS",o.content=a}catch(a){console.error("Error getting user tokens:",a),o.action="ERROR",o.error="Failed to get user tokens"}}else{await N();const a=h();if(a&&(a.idToken||a.accessToken))try{const d=a;o.action="SET_TOKENS",o.content=d}catch(d){console.error("Error getting user tokens:",d),o.action="ERROR",o.error="Failed to get user tokens"}else o.action="NO_USER"}if(console.log("[R][PLAY][updateIframe][message-GET_TOKENS] Sending response:",o),!e.source)return;e.source.postMessage(o,{targetOrigin:e.origin})}else if(n.action!=="SWITCH_SERVER"){if(n.action!=="CACHE_ENABLED"){if(!e.source)return;e.source.postMessage({action:"UNKNOWN_ACTION",requestId:n.requestId},{targetOrigin:e.origin})}}}catch(r){if(!e.source)return;e.source.postMessage({action:"ERROR",error:r.message,requestId:e.data.requestId})}}))});var R=oe();M(e=>{T(()=>j.title=`${t(c)?`Testing ${t(c)}`:"Integration Test"} | CCPorted`)});var O=v(R);g(O,e=>{t(b)&&!t(y)&&t(U)});var S=_(O,2);{var C=e=>{var r=ee();J(r,s=>E(l,s),()=>t(l)),T(()=>D(r,"src",t(c))),u(e,r)},P=e=>{var r=B(),s=v(r);{var n=i=>{var a=re(),d=_(I(a),2),$=I(d,!0);w(d),w(a),T(()=>G($,t(p))),u(i,a)},o=i=>{var a=te();u(i,a)};g(s,i=>{t(p)?i(n):i(o,!1)},!0)}u(e,r)};g(S,e=>{t(c)?e(C):e(P,!1)})}var Y=_(S,2);g(Y,e=>{}),u(A,R),z()}F(["click"]);export{ue as component};
